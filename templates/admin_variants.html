{% extends 'layout.html' %}{% block content %}<div class='d-flex align-items-center mb-3'><h1 class='h4 mb-0'>管理規格 / 尺寸：{{ product.name }}</h1><a class='btn btn-outline-secondary ms-auto' href='{{ url_for('admin_products') }}'>返回商品列表</a></div><div class='card mb-4'><div class='card-body'><h2 class='h5'>新增規格</h2><form method='post' onsubmit='return buildJsonBeforeSubmit(this);'><div class='row g-3 align-items-end'><div class='col-sm-3'><label class='form-label'>SKU</label><input type='text' name='sku' class='form-control' placeholder='可留空'></div><div class='col-sm-2'><label class='form-label'>庫存</label><input type='number' name='stock' class='form-control' value='0' min='0'></div><div class='col-12'><label class='form-label'>屬性（彈性欄位）</label><div id='attrs' class='row g-2'><div class='col-sm-4'><input class='form-control' name='attr_key' placeholder='例如：size 或 尺寸'></div><div class='col-sm-4'><input class='form-control' name='attr_val' placeholder='例如：M'></div><div class='col-sm-4'><button class='btn btn-outline-secondary' type='button' onclick='addRow()'>＋ 增加一列</button></div></div><div class='form-text'>送出前會自動轉成 JSON；也可直接手動編輯下方 JSON。</div><textarea class='form-control mt-2' name='attributes_json' rows='4' placeholder='{"size":"M","顏色":"黑"}'></textarea></div><div class='col-12'><button class='btn btn-primary'>新增規格</button></div></div></form></div></div><h2 class='h5'>已建立的規格</h2><div class='table-responsive'><table class='table align-middle'><thead><tr><th>ID</th><th>SKU</th><th>庫存</th><th>屬性 JSON</th><th style='width:220px'>操作</th></tr></thead><tbody>{% for v in variants %}<tr><td>{{ v.id }}</td><td>{{ v.sku or '-' }}</td><td>{{ v.stock }}</td><td style='max-width:400px'><pre class='json mb-0'>{{ v.attributes_json }}</pre></td><td class='text-nowrap'><button class='btn btn-sm btn-outline-primary' data-bs-toggle='collapse' data-bs-target='#edit{{ v.id }}'>編輯</button><form class='d-inline' method='post' action='{{ url_for('admin_variant_delete', variant_id=v.id) }}' onsubmit="return confirm('確定刪除？');"><button class='btn btn-sm btn-outline-danger'>刪除</button></form></td></tr><tr class='collapse' id='edit{{ v.id }}'><td colspan='5'><form method='post' action='{{ url_for('admin_variant_edit', variant_id=v.id) }}'><div class='row g-2 align-items-end'><div class='col-sm-3'><label class='form-label'>SKU</label><input type='text' name='sku' class='form-control' value='{{ v.sku }}'></div><div class='col-sm-2'><label class='form-label'>庫存</label><input type='number' name='stock' class='form-control' value='{{ v.stock }}'></div><div class='col-12'><label class='form-label'>屬性 JSON</label><textarea name='attributes_json' class='form-control' rows='4'>{{ v.attributes_json }}</textarea></div><div class='col-12'><button class='btn btn-primary btn-sm'>儲存</button></div></div></form></td></tr>{% endfor %}{% if not variants %}<tr><td colspan='5' class='text-center text-muted'>尚無規格</td></tr>{% endif %}</tbody></table></div><script>function addRow(){const row=document.createElement('div');row.className='col-12 row g-2 mt-1';row.innerHTML=`<div class='col-sm-4'><input class='form-control' name='attr_key' placeholder='Key'></div><div class='col-sm-4'><input class='form-control' name='attr_val' placeholder='Value'></div><div class='col-sm-4'><button type='button' class='btn btn-outline-danger' onclick='this.closest(".row").remove()'>刪除此列</button></div>`;document.getElementById('attrs').appendChild(row);}function buildJsonBeforeSubmit(form){const keys=Array.from(form.querySelectorAll('input[name="attr_key"]')).map(i=>i.value.trim());const vals=Array.from(form.querySelectorAll('input[name="attr_val"]')).map(i=>i.value.trim());let obj={};const ta=form.querySelector('textarea[name="attributes_json"]');if(ta&&ta.value.trim()){try{obj=JSON.parse(ta.value.trim())}catch(e){obj={}}}keys.forEach((k,idx)=>{if(k)obj[k]=vals[idx]||''});if(ta)ta.value=JSON.stringify(obj,null,2);return true;}</script>{% endblock %}